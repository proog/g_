angular.module("games",["ngRoute","ngResource","ngCookies","lr.upload","ui.bootstrap","angular-loading-bar"]).config(["$routeProvider","cfpLoadingBarProvider",function(o,e){o.when("/:userId?/:gameId?",{templateUrl:"content.html",controller:"gamesCtrl",controllerAs:"ctrl"}).otherwise({redirectTo:"/"}),e.latencyThreshold=500,e.includeSpinner=!1}]).run(["$rootScope","$modalStack",function(o,e){o.$on("$routeChangeSuccess",function(){e.dismissAll()})}]);
angular.module("games").controller("formCtrl",["$scope","$modalInstance","game","gameService","Games",function(e,i,l,n,o){e.initialize=function(){e.genres=n.genres,e.platforms=n.platforms,e.tags=n.tags,e.gameService=n,e.error=null,e.STATE_DEFAULT=0,e.STATE_ON_WISHLIST=1,e.STATE_IN_QUEUE=2,e.STATE_CURRENTLY_PLAYING=3,l?(e.isNew=!1,e.model=angular.copy(l),e.state=e.model.currently_playing?e.STATE_CURRENTLY_PLAYING:null!=e.model.queue_position?e.STATE_IN_QUEUE:null!=e.model.wishlist_position?e.STATE_ON_WISHLIST:e.STATE_DEFAULT):(e.isNew=!0,e.state=e.STATE_DEFAULT,e.model={title:null,developer:null,publisher:null,year:null,comment:null,sort_as:null,finished:n.NOT_FINISHED,playtime:null,rating:null,currently_playing:!1,queue_position:null,hidden:!1,wishlist_position:null,genre_ids:[],platform_ids:[],tag_ids:[]});var i;null!=e.model.queue_position?e.originalQueuePosition=e.model.queue_position:(i=n.games.reduce(function(e,i){return null!=i.queue_position?Math.max(i.queue_position,e):e},-1),e.originalQueuePosition=i+1),null!=e.model.wishlist_position?e.originalWishlistPosition=e.model.wishlist_position:(i=n.games.reduce(function(e,i){return null!=i.wishlist_position?Math.max(i.wishlist_position,e):e},-1),e.originalWishlistPosition=i+1)},e.genreClick=function(i){var l=e.model.genre_ids.indexOf(i);l>-1?e.model.genre_ids.splice(l,1):e.model.genre_ids.push(i)},e.platformClick=function(i){var l=e.model.platform_ids.indexOf(i);l>-1?e.model.platform_ids.splice(l,1):e.model.platform_ids.push(i)},e.tagClick=function(i){var l=e.model.tag_ids.indexOf(i);l>-1?e.model.tag_ids.splice(l,1):e.model.tag_ids.push(i)},e.clearImageInput=function(){for(var i=0;i<e.image.length;i++)try{e.image[i].value="",e.image[i].value&&(e.image[i].type="text",e.image[i].type="file")}catch(l){}e.filename=null},e.titleChanged=function(){e.model.sort_as=e.model.title?e.model.title.replace(/^The\s|A\s|An\s/,""):null},e.yearButtonClicked=function(){e.model.year=(new Date).getFullYear()},e.fileChanged=function(){e.$apply(function(){e.filename=e.image&&e.image[0]&&e.image[0].files&&e.image[0].files.length>0?e.image[0].files[0].name:null})},e.currentlyPlayingClicked=function(){e.model.currently_playing=!0,e.model.queue_position=null,e.model.wishlist_position=null},e.inQueueClicked=function(){e.model.currently_playing=!1,e.model.queue_position=e.originalQueuePosition,e.model.wishlist_position=null},e.onWishlistClicked=function(){e.model.currently_playing=!1,e.model.queue_position=null,e.model.wishlist_position=e.originalWishlistPosition,e.model.finished=n.NOT_FINISHED,e.model.rating=null,e.model.playtime=null},e.defaultClicked=function(){e.model.currently_playing=!1,e.model.queue_position=null,e.model.wishlist_position=null},e.formSubmit=function(){var t=function(){e.image&&e.image[0].files.length>0?l.uploadImage(e.image).then(function(){i.close()},function(i){e.error=i.data.message}):i.close()};if(e.model.rating&&0!=e.model.rating.length||(e.model.rating=null),e.isNew)l=new o(e.model),l.$save({userId:n.authenticatedUser.id},function(){n.games.push(l),t()},function(i){e.error=i.data.message});else{var s=new o(e.model);s.$update(function(e){angular.copy(e,l),t()},function(i){e.error=i.data.message})}},e.deleteClick=function(){var o=confirm("Are you sure you want to delete "+e.model.title+"?");o&&l.$delete(function(){var e=n.games.indexOf(l);e>-1&&n.games.splice(e,1),i.close()},function(i){e.error=i.data.message})},e.cancelClick=function(){i.dismiss()},e.closeAlert=function(){e.error=null},e.initialize()}]);
angular.module("games").controller("gamesCtrl",["$scope","$routeParams","$route","$http","$q","$location","upload","$modal","$filter","Games","Genres","Platforms","Tags","Users","gameService","$cookies","searchFilter","$timeout",function(e,t,n,a,r,i,o,u,l,s,c,m,g,f,p,h,d,v){"use strict";var y=this;y.countFinished=function(){return p.countFinished()},y.countFinishedPct=function(){return p.countFinishedPct()},y.isInSuggestions=function(e){return p.isInSuggestions(e)},y.addClick=function(){y.openGameForm(null)},y.editClick=function(e){y.openGameForm(e)},y.openGameForm=function(e){var t=u.open({templateUrl:"form.html",controller:"formCtrl",size:"lg",backdrop:"static",resolve:{game:function(){return e}}});t.result.then(function(){y.updateChart()})},y.manageGenresClick=function(){y.openManageForm(c,p.genres,"genre")},y.managePlatformsClick=function(){y.openManageForm(m,p.platforms,"platform")},y.manageTagsClick=function(){y.openManageForm(g,p.tags,"tag")},y.openManageForm=function(e,t){var n=u.open({templateUrl:"manage.html",controller:"manageFormCtrl",backdrop:"static",resolve:{Entities:function(){return e},items:function(){return t}}});n.result.then(function(){y.updateChart()})},y.manageQueueClick=function(){y.openReorderForm("queue_position")},y.manageWishlistClick=function(){y.openReorderForm("wishlist_position")},y.openReorderForm=function(e){var t=u.open({templateUrl:"queue.html",controller:"queueFormCtrl",size:"sm",backdrop:"static",resolve:{games:function(){var t={};return t[e]="!!",l("filter")(p.games,t)},property:function(){return e}}});t.result.then(function(){y.updateChart()})},y.pageChanged=function(){y.offset=y.currentPage*y.itemsPerPage-y.itemsPerPage},y.loginClick=function(){var e=u.open({templateUrl:"login.html",controller:"loginFormCtrl",size:"sm",backdrop:"static",resolve:{loginUrl:function(){return"api/login"}}});e.result.then(function(e){p.authenticated=!0,p.authenticatedUser=e})},y.logoutClick=function(){a.post("api/logout").success(function(){p.authenticated=!1,p.authenticatedUser=null})},y.aboutClick=function(){u.open({templateUrl:"about.html",size:"sm",backdrop:"static"})},y.viewChanged=function(e){(e==y.GRID_VIEW||e==y.LIST_VIEW)&&(y.view=e,h.view=e,v(function(){y.updateChart()},500))},y.gameSelected=function(e,t){y.selectedGame=e,t&&y.scrollToGame(e)},y.openLinkDialog=function(e){u.open({templateUrl:"link.html",controller:"linkCtrl",size:"sm",backdrop:"static",resolve:{url:function(){var t=i.protocol()+"://",n=i.host(),a=80!=i.port()?":"+i.port():"",r=window.location.pathname,o="#/"+y.userId,u="/"+e.id;return t+n+a+r+o+u}}})},y.changeUser=function(e){e.id!=y.userId&&(p.resetAll(),i.path("/"+e.id))},y.canShowAuthenticatedMenuItems=function(){return p.authenticated&&p.authenticatedUser.id==y.userId&&p.initialized},y.initFilter=function(){var e="Year",t="Rating",n="Miscellanous";y.filterOptions=[{name:"Title contains",value:p.FILTER_TITLE,group:n},{name:"Completion is",value:p.FILTER_COMPLETION,group:n},{name:"Platform is",value:p.FILTER_PLATFORM,group:n},{name:"Genre is",value:p.FILTER_GENRE,group:n},{name:"Tag is",value:p.FILTER_TAG,group:n},{name:"Year is exactly",value:p.FILTER_YEAR,group:e},{name:"Year is at least",value:p.FILTER_YEAR_MIN,group:e},{name:"Year is at most",value:p.FILTER_YEAR_MAX,group:e},{name:"Rating is exactly",value:p.FILTER_RATING,group:t},{name:"Rating is at least",value:p.FILTER_RATING_MIN,group:t},{name:"Rating is at most",value:p.FILTER_RATING_MAX,group:t}]},y.addQueryParameter=function(){y.query.parameters.push({type:null,value:null,negate:!1})},y.removeQueryParameter=function(e){var t=y.query.parameters.indexOf(e);t>-1&&y.query.parameters.splice(t,1)},y.resetFilter=function(){y.query||(y.query={}),y.query.parameters=[],y.sorting=y.sortOptions[0].value},y.toggleFilterPanel=function(){y.showFilters=!y.showFilters},y.isFilterOn=function(){return y.query&&y.query.parameters&&y.query.parameters.length},y.scrollToGame=function(e){if(y.sections.all_games&&y.collapseSection("all_games"),y.view==y.GRID_VIEW)for(var t=0;t<y.filtered.length;t++){var n=y.filtered[t];if(n==e){y.currentPage=parseInt(t/y.itemsPerPage)+1,v(function(){var t=$("#game"+e.id);if(t.length){var n=$("body,html");n.animate({scrollTop:t.offset().top-50-n.height()/2+t.height()/2})}});break}}else y.view==y.LIST_VIEW&&v(function(){var t=$("#game"+e.id);if(t.length){var n=$("#game-list");n.animate({scrollTop:n.scrollTop()+t.position().top+50-n.height()/2+t.height()/2})}})},y.collapseSection=function(e){var t=!y.sections[e];y.sections[e]=t,h[e]=t?1:0,"statistics"!=e||t||v(function(){y.chart.instance.resize(y.chart.instance.render,!0)})},y.changeTheme=function(){e.changeStyle(),y.updateChart()},y.refreshSuggestions=function(e){e.stopPropagation(),p.refreshSuggestions(y.userId)},y.updateChart=function(){var t=y.chart.orderBy(y.chart.xAxis(y.chart.yAxis)),n=[],a=[];angular.forEach(t,function(e){n.push(e.label),a.push(e.value)});var r={labels:n,datasets:[{fillColor:"rgba(151,187,205,0.2)",strokeColor:"rgba(151,187,205,1)",pointColor:"rgba(151,187,205,1)",pointStrokeColor:"#fff",pointHighlightFill:"#fff",pointHighlightStroke:"rgba(151,187,205,1)",data:a}]},i=document.getElementById("stats-chart").getContext("2d"),o={animation:!1,responsive:!0,scaleBeginsAtZero:!0,pointHitDetectionRadius:5,scaleFontColor:e.globalOptions.darkStyle?"#fff":"#333"};y.chart.instance&&y.chart.instance.destroy(),y.chart.instance=new Chart(i).Line(r,o)},y.initChart=function(){var e=function(e){var t=[];return angular.forEach(e,function(e){e.hasPlaytime()&&t.push(moment.duration(e.playtime).asHours())}),t},t=function(e){var t=[];return angular.forEach(e,function(e){e.hasRating()&&t.push(e.rating)}),t};y.chart={instance:null,xAxis:null,yAxis:null,orderBy:null,xOptions:[{name:"Genre",value:function(e){var t=[];return angular.forEach(p.genres,function(n){var a=l("filter")(p.getOwnedGames(),function(e){return e.genre_ids.indexOf(n.id)>-1});t.push({label:n.name,value:e(a)})}),t}},{name:"Platform",value:function(e){var t=[];return angular.forEach(p.platforms,function(n){var a=l("filter")(p.getOwnedGames(),function(e){return e.platform_ids.indexOf(n.id)>-1});t.push({label:n.name,value:e(a)})}),t}},{name:"Tag",value:function(e){var t=[];return angular.forEach(p.tags,function(n){var a=l("filter")(p.getOwnedGames(),function(e){return e.tag_ids.indexOf(n.id)>-1});t.push({label:n.name,value:e(a)})}),t}},{name:"Year",value:function(e){var t=[];return angular.forEach(p.getYears(),function(n){var a=l("filter")(p.getOwnedGames(),function(e){return e.year==n});t.push({label:n,value:e(a)})}),t}}],yOptions:[{name:"Games",group:"Quantity",value:function(e){return e.length}},{name:"Completed games",group:"Quantity",value:function(e){return e.reduce(function(e,t){return t.finished==p.FINISHED?e+1:e},0)}},{name:"Average playtime",group:"Playtime",value:function(t){var n=e(t);return n.length?n.reduce(function(e,t){return e+t},0)/n.length:0}},{name:"Median playtime",group:"Playtime",value:function(t){var n=e(t);if(!n.length)return 0;var a=l("orderBy")(n),r=Math.floor(a.length/2);return a.length%2?a[r]:(a[r-1]+a[r])/2}},{name:"Maximum playtime",group:"Playtime",value:function(t){return e(t).reduce(function(e,t){return Math.max(t,e)},0)}},{name:"Average rating",group:"Rating",value:function(e){var n=t(e);return n.length?n.reduce(function(e,t){return e+t},0)/n.length:0}},{name:"Maximum rating",group:"Rating",value:function(e){return t(e).reduce(function(e,t){return Math.max(t,e)},0)}}],orderOptions:[{name:"Category",value:function(e){return l("orderBy")(e,"label")}},{name:"Value",value:function(e){return l("orderBy")(e,"value")}}]},y.chart.xAxis=y.chart.xOptions[0].value,y.chart.yAxis=y.chart.yOptions[0].value,y.chart.orderBy=y.chart.orderOptions[0].value},y.init=function(){if(y.finishedOptions=[{name:"Completed",value:1},{name:"Not completed",value:0},{name:"Shelved",value:3},{name:"N/A",value:2}],y.sortOptions=[{name:"Sort by title, asc.",value:"sort_as"},{name:"Sort by title, desc.",value:"-sort_as"},{name:"Sort by year, asc.",value:["year","sort_as"]},{name:"Sort by year, desc.",value:[function(e){return null!=e.year?-e.year:Number.MAX_VALUE},"sort_as"]},{name:"Sort by rating, asc.",value:["rating","sort_as"]},{name:"Sort by rating, desc.",value:[function(e){return e.hasRating()?-e.rating:Number.MAX_VALUE},"sort_as"]},{name:"Sort by playtime, asc.",value:[function(e){return e.hasPlaytime()?e.playtimeAsInt():Number.MAX_VALUE},"sort_as"]},{name:"Sort by playtime, desc.",value:[function(e){return e.hasPlaytime()?-e.playtimeAsInt():Number.MAX_VALUE},"sort_as"]}],y.sections={currently_playing:1==h.currently_playing,queue:1==h.queue,all_games:1==h.all_games,statistics:1==h.statistics,suggestions:1==h.suggestions},y.offset=0,y.itemsPerPage=18,y.currentPage=1,y.showFilters=!1,y.selectedGame=null,y.GRID_VIEW=1,y.LIST_VIEW=2,y.view=h.view?h.view:y.LIST_VIEW,y.gameService=p,y.initFilter(),y.resetFilter(),y.initChart(),!t.userId)return void a.get("api/config").success(function(e){y.userId=e.default_user.id,i.path("/"+y.userId).replace()});y.userId=t.userId;var n=function(){t.gameId&&angular.forEach(p.getOwnedGames(),function(e){e.id==t.gameId&&y.gameSelected(e)}),v(function(){y.updateChart()})};if(p.initialized)n();else{p.checkLogin();var r=p.refreshAll(y.userId);r.then(n)}e.$watch(function(){return y.currentPage},function(){y.pageChanged()})},y.init()}]);
angular.module("games").controller("globalCtrl",["$scope","$cookies",function(l,t){l.globalOptions={darkStyle:!0},l.changeStyle=function(){l.globalOptions.darkStyle=!l.globalOptions.darkStyle,t.darkStyle=l.globalOptions.darkStyle?1:0},this.init=function(){l.globalOptions.darkStyle=1==t.darkStyle},this.init()}]);
angular.module("games").controller("linkCtrl",["$scope","$modalInstance","url",function(l,n,o){l.url=o}]);
angular.module("games").controller("loginFormCtrl",["$scope","$modalInstance","$http","loginUrl",function(o,r,n,l){o.loginClick=function(){o.loginError=!1,n.post(o.loginUrl,o.loginForm).success(function(n){o.resetForm(),r.close(n)}).error(function(){o.loginError=!0})},o.cancelClick=function(){o.resetForm(),r.dismiss()},o.resetForm=function(){o.loginError=!1,o.loginForm={username:"",password:""}},o.loginUrl=l,o.resetForm()}]);
angular.module("games").controller("manageFormCtrl",["$scope","$modalInstance","$filter","Entities","items","gameService","$q",function(e,t,n,a,i,r,s){e.initialize=function(){e.form={},e.originalItems=i,e.items=angular.copy(i),e.type=a.prototype.type,e.error=null,e.STATE_UNCHANGED=1,e.STATE_ADDED=2,e.STATE_UPDATED=3,e.STATE_DELETED=4,angular.forEach(e.items,function(t){t.state=e.STATE_UNCHANGED}),e.items=n("orderBy")(e.items,"name")},e.addClick=function(){var t=new a(e.form);t.state=e.STATE_ADDED,e.items.push(t),e.form={}},e.deleteClick=function(t){t.state==e.STATE_ADDED?e.items.splice(e.items.indexOf(t)):t.state=e.STATE_DELETED},e.nameChange=function(t){t.state!=e.STATE_ADDED&&(t.state=e.STATE_UPDATED),t.short_name=t.name},e.shortNameChange=function(t){t.state!=e.STATE_ADDED&&(t.state=e.STATE_UPDATED)},e.saveClick=function(){var n=[];angular.forEach(e.items,function(t){switch(t.state){case e.STATE_ADDED:n.push(t.$save({userId:r.authenticatedUser.id},function(t){e.originalItems.push(t)}));break;case e.STATE_UPDATED:n.push(t.$update(function(n){angular.forEach(e.originalItems,function(e){e.id==t.id&&angular.copy(n,e)})}));break;case e.STATE_DELETED:n.push(t.$delete(function(){var n=e.originalItems.reduce(function(e,n,a){return n.id==t.id?a:e},-1);n>-1&&e.originalItems.splice(n,1);var i=a.prototype.ids;angular.forEach(r.games,function(e){var n=e[i].reduce(function(e,n,a){return t.id==n?a:e},-1);n>-1&&e[i].splice(n,1)})}))}}),s.all(n).then(function(){t.close()},function(){e.error="Could not save all items. Please check that all fields are filled out."})},e.cancelClick=function(){t.dismiss()},e.canSave=function(){for(var t=0;t<e.items.length;t++){var n=e.items[t];if(!n.name||!n.short_name)return!1}return!0},e.closeAlert=function(){e.error=null},e.initialize()}]);
angular.module("games").controller("queueFormCtrl",["$scope","$modalInstance","$filter","games","property","gameService","$q",function(e,n,o,r,i,a,t){e.initialize=function(){e.games=angular.copy(r),e.property=i,e.filterObject={},e.filterObject[i]="!!",e.error=null,e.rewriteQueue()},e.rewriteQueue=function(){e.games=o("orderBy")(e.games,[e.property,"sort_as"]);var n=0;angular.forEach(e.games,function(e){null!=e[i]&&(e[i]=n++)})},e.getMaxPosition=function(){return e.games.reduce(function(e,n){return null==n[i]?e:e+1},0)-1},e.move=function(n,o){angular.forEach(e.games,function(e){e!=n&&null!=e[i]&&(e[i]>n[i]&&e[i]--,e[i]>=o&&e[i]++)}),n[i]=o},e.moveUpClick=function(n){0==n[i]?e.move(n,e.getMaxPosition()):e.move(n,n[i]-1)},e.moveDownClick=function(n){n[i]==e.getMaxPosition()?e.move(n,0):e.move(n,n[i]+1)},e.removeClick=function(n){angular.forEach(e.games,function(e){e!=n&&null!=e[i]&&e[i]>=n[i]&&e[i]--}),n[i]=null},e.saveClick=function(){e.rewriteQueue();var o=[];angular.forEach(e.games,function(e){angular.forEach(a.games,function(n){n.id==e.id&&(n[i]=e[i],o.push(n.$update()))})}),t.all(o).then(function(){n.close()},function(){e.error="Could not save all positions. Please try again."})},e.cancelClick=function(){n.dismiss()},e.closeAlert=function(){e.error=null},e.initialize()}]);
angular.module("games").directive("bindElement",function(){return{restrict:"A",scope:{bindElement:"="},link:function(e,n){e.bindElement=n}}});
angular.module("games").directive("game",["gameService","$filter",function(e,t){return{restrict:"E",templateUrl:"game.html",scope:{game:"=",editCallback:"&",linkCallback:"&",height:"@"},link:function(i){i.heightStyle=i.height?{height:i.height}:{},i.gameService=e,i.getGenres=function(){return t("filter")(e.genres,function(e){return i.game.genre_ids.indexOf(e.id)>-1})},i.getPlatforms=function(){return t("filter")(e.platforms,function(e){return i.game.platform_ids.indexOf(e.id)>-1})},i.getTags=function(){return t("filter")(e.tags,function(e){return i.game.tag_ids.indexOf(e.id)>-1})}}}}]);
angular.module("games").directive("statsPanel",function(){return{templateUrl:"stats.html",scope:{panelTitle:"@",key:"@",value:"@",items:"=",filterBy:"=",orderBy:"=",descending:"@",onClick:"&"},link:function(e){e.itemsPerPage=10,e.pageChanged=function(){e.offset=e.currentPage*e.itemsPerPage-e.itemsPerPage},e.itemClicked=function(t){e.onClick({item:t})}}}});
angular.module("games").directive("validateTimespan",function(){return{require:"ngModel",link:function(e,n,t,i){var r=/^\d{1,2}:\d{2}(:\d{2})?$/;i.$validators.timespan=function(e,n){return i.$isEmpty(n)?!0:r.test(n)}}}}).directive("validateYear",function(){return{require:"ngModel",link:function(e,n,t,i){var r=/^\d+$/;i.$validators.year=function(e,n){return i.$isEmpty(n)?!0:r.test(n)}}}});
angular.module("games").factory("Games",["$resource","upload",function(t,e){var i=t("api/users/:userId/games/:id",{id:"@id",userId:"@user_id"},{query:{method:"GET",isArray:!0,transformResponse:function(t){var e=angular.fromJson(t);return angular.forEach(e,function(t){n(t)}),e}},get:{method:"GET",isArray:!1,transformResponse:function(t){var e=angular.fromJson(t);return n(e)}},save:{method:"POST",transformResponse:function(t){var e=angular.fromJson(t);return n(e)}},update:{method:"PUT",transformResponse:function(t){var e=angular.fromJson(t);return n(e)}}}),n=function(t){if(t.decachedImage=t.image,t.title){var e=": ",i=t.title.indexOf(e);i>-1?(t.mainTitle=t.title.substr(0,i),t.subTitle=t.title.substr(i+e.length)):t.mainTitle=t.title}return t};return i.prototype.uploadImage=function(t){var i=this;return e({url:"api/users/"+i.user_id+"/games/"+i.id+"/image",method:"POST",data:{image:t}}).then(function(t){var e=t.data;i.image=e.image,i.decachedImage=i.image+"?q="+(new Date).getTime()})},i.prototype.playtimeAsInt=function(){return this.hasPlaytime()?parseInt(this.playtime.split(":").join("")):0},i.prototype.hasPlaytime=function(){return this.playtime&&"00:00:00"!=this.playtime},i.prototype.hasRating=function(){return null!=this.rating},i.prototype.isOnWishlist=function(){return null!==this.wishlist_position},i.prototype.isInQueue=function(){return null!==this.queue_position},i.prototype.getPlaytimeDisplay=function(){if(!this.playtime)return"";var t=this.playtime.split(":"),e=t[0],i=t[1];return 0==e.indexOf("00")?e="":0==e.indexOf("0")?e=e.substr(1)+" hours":e+=" hours",0==i.indexOf("00")?i="":0==i.indexOf("0")?i=i.substr(1)+" mins":i+=" mins",e+" "+i},i}]);
angular.module("games").factory("Users",["$resource",function(e){var r=e("api/users/:id",{id:"@id"},{update:{method:"PUT"}});return r}]);
angular.module("games").factory("Genres",["$resource",function(e){var r=e("api/users/:userId/genres/:id",{id:"@id",userId:"@user_id"},{update:{method:"PUT"}});return r.prototype.type="genre",r.prototype.ids="genre_ids",r}]).factory("Platforms",["$resource",function(e){var r=e("api/users/:userId/platforms/:id",{id:"@id",userId:"@user_id"},{update:{method:"PUT"}});return r.prototype.type="platform",r.prototype.ids="platform_ids",r}]).factory("Tags",["$resource",function(e){var r=e("api/users/:userId/tags/:id",{id:"@id",userId:"@user_id"},{update:{method:"PUT"}});return r.prototype.type="tag",r.prototype.ids="tag_ids",r}]);
angular.module("games").filter("offset",function(){return function(e,n){return e.slice(n)}});
angular.module("games").filter("search",["gameService",function(e){return function(a,r){var t=r.search?r.search.toLowerCase():!1,n=[];return angular.forEach(a,function(a){if(t){var l=a.title&&a.title.toLowerCase().indexOf(t)>=0,u=a.sort_as&&a.sort_as.toLowerCase().indexOf(t)>=0,i=a.developer&&a.developer.toLowerCase().indexOf(t)>=0,o=a.publisher&&a.publisher.toLowerCase().indexOf(t)>=0,s=a.comment&&a.comment.toLowerCase().indexOf(t)>=0;if(!(l||u||i||o||s))return}var L=!0;angular.forEach(r.parameters,function(r){L&&r.type&&null!==r.value&&""!==r.value&&(r.type==e.FILTER_PLATFORM&&a.platform_ids.indexOf(r.value)<0?L=!1:r.type==e.FILTER_GENRE&&a.genre_ids.indexOf(r.value)<0?L=!1:r.type==e.FILTER_TAG&&a.tag_ids.indexOf(r.value)<0?L=!1:r.type!=e.FILTER_YEAR||null!=a.year&&a.year==r.value?r.type==e.FILTER_YEAR_MIN&&(null==a.year||a.year<r.value)?L=!1:r.type==e.FILTER_YEAR_MAX&&(null==a.year||a.year>r.value)?L=!1:r.type==e.FILTER_COMPLETION&&a.finished!=r.value?L=!1:r.type!=e.FILTER_RATING||null!=a.rating&&a.rating==r.value?r.type==e.FILTER_RATING_MIN&&(null==a.rating||a.rating<r.value)?L=!1:r.type==e.FILTER_RATING_MAX&&(null==a.rating||a.rating>r.value)?L=!1:r.type==e.FILTER_TITLE&&a.title.toLowerCase().indexOf(r.value)<0&&(L=!1):L=!1:L=!1,r.negate&&(L=!L))}),L&&n.push(a)}),n}}]);
angular.module("games").service("gameService",["Games","Genres","Platforms","Tags","Users","$q","$routeParams","$http","$filter",function(e,n,t,r,s,i,u,f,o){var a=this;a.refreshGames=function(n){return e.query({userId:n}).$promise.then(function(e){a.games=e})},a.refreshGenres=function(e){return n.query({userId:e}).$promise.then(function(e){a.genres=e})},a.refreshPlatforms=function(e){return t.query({userId:e}).$promise.then(function(e){a.platforms=e})},a.refreshTags=function(e){return r.query({userId:e}).$promise.then(function(e){a.tags=e})},a.refreshUsers=function(){return s.query().$promise.then(function(e){a.users=e})},a.refreshSuggestions=function(e){return f.get("api/users/"+e+"/suggestions").success(function(e){a.suggestions=e})},a.refreshAll=function(e){return a.resetAll(),i.all([a.refreshGames(e),a.refreshGenres(e),a.refreshPlatforms(e),a.refreshTags(e),a.refreshSuggestions(e),a.refreshUsers()]).then(function(){a.initialized=!0})},a.resetAll=function(){a.initialized=!1,a.games=[],a.genres=[],a.platforms=[],a.tags=[],a.suggestions=[],a.users=[]},a.checkLogin=function(){return f.get("api/login").success(function(e){a.authenticated=!0,a.authenticatedUser=e})},a.isGameVisible=function(e){return!e.hidden||a.authenticated&&a.authenticatedUser.id==e.user_id},a.getOwnedGames=function(){return o("filter")(a.games,function(e){return e.isOnWishlist()?!1:a.isGameVisible(e)})},a.getWishlistGames=function(){return o("filter")(a.games,function(e){return e.isOnWishlist()?a.isGameVisible(e):!1})},a.getQueuedGames=function(){return o("filter")(a.getOwnedGames(),function(e){return e.isInQueue()})},a.getFinishedGames=function(){return o("filter")(a.getOwnedGames(),function(e){return e.finished==a.FINISHED})},a.getUnfinishedGames=function(){return o("filter")(a.getOwnedGames(),function(e){return e.finished!=a.FINISHED})},a.getYears=function(){var e=[];return angular.forEach(a.getOwnedGames(),function(n){n.year&&e.indexOf(n.year)<0&&e.push(n.year)}),e},a.countFinished=function(){return a.getOwnedGames().reduce(function(e,n){return n.finished==a.FINISHED?e+1:e},0)},a.countFinishedPct=function(){return Math.round(a.countFinished()/a.getOwnedGames().length*100)},a.countGenre=function(e){return a.getOwnedGames().reduce(function(n,t){return t.genre_ids.indexOf(e.id)>-1?n+1:n},0)},a.countPlatform=function(e){return a.getOwnedGames().reduce(function(n,t){return t.platform_ids.indexOf(e.id)>-1?n+1:n},0)},a.countTag=function(e){return a.getOwnedGames().reduce(function(n,t){return t.tag_ids.indexOf(e.id)>-1?n+1:n},0)},a.isInSuggestions=function(e){return a.suggestions.reduce(function(n,t){return n||t.game_id==e.id},!1)},a.FILTER_TITLE=1,a.FILTER_PLATFORM=2,a.FILTER_GENRE=3,a.FILTER_TAG=4,a.FILTER_YEAR=5,a.FILTER_RATING=6,a.FILTER_COMPLETION=7,a.FILTER_TITLE=8,a.FILTER_YEAR_MIN=9,a.FILTER_YEAR_MAX=10,a.FILTER_RATING_MIN=11,a.FILTER_RATING_MAX=12,a.NOT_FINISHED=0,a.FINISHED=1,a.FINISHED_NA=2,a.SHELVED=3,a.authenticated=!1,a.authenticatedUser=null,a.resetAll()}]);