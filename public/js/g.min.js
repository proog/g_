angular.module("games",["ngRoute","ngResource","ngCookies","lr.upload","ui.bootstrap","angular-loading-bar"]).config(["$routeProvider","cfpLoadingBarProvider",function(o,e){o.when("/:userId?/:gameId?",{templateUrl:"content.html",controller:"gamesCtrl",controllerAs:"ctrl"}).otherwise({redirectTo:"/"}),e.latencyThreshold=500,e.includeSpinner=!1}]).run(["$rootScope","$modalStack",function(o,e){o.$on("$routeChangeSuccess",function(){e.dismissAll()})}]);
angular.module("games").controller("formCtrl",["$scope","$modalInstance","game","genres","platforms","tags","games","gameService",function(e,i,l,o,n,a,t,s){e.initialize=function(){if(e.genres=o,e.platforms=n,e.tags=a,e.games=t,e.gameService=s,l?(e.isNew=!1,e.model=angular.copy(l)):(e.isNew=!0,e.model={title:null,developer:null,publisher:null,year:null,comment:null,sort_as:null,finished:s.NOT_FINISHED,playtime:null,rating:null,currently_playing:!1,queue_position:null,hidden:!1,genre_ids:[],platform_ids:[],tag_ids:[]}),null!=e.model.queue_position)e.originalQueuePosition=e.model.queue_position;else{var i=-1;angular.forEach(e.games,function(e){null!=e.queue_position&&e.queue_position>i&&(i=e.queue_position)}),e.originalQueuePosition=i+1}},e.genreClick=function(i){var l=e.model.genre_ids.indexOf(i);l>-1?e.model.genre_ids.splice(l,1):e.model.genre_ids.push(i)},e.platformClick=function(i){var l=e.model.platform_ids.indexOf(i);l>-1?e.model.platform_ids.splice(l,1):e.model.platform_ids.push(i)},e.tagClick=function(i){var l=e.model.tag_ids.indexOf(i);l>-1?e.model.tag_ids.splice(l,1):e.model.tag_ids.push(i)},e.clearImageInput=function(){for(var i=0;i<e.image.length;i++)try{e.image[i].value="",e.image[i].value&&(e.image[i].type="text",e.image[i].type="file")}catch(l){}},e.titleChanged=function(){e.model.sort_as=e.model.title.replace(/^The\s|A\s|An\s/,"")},e.inQueueClicked=function(){e.model.queue_position=null==e.model.queue_position?e.originalQueuePosition:null},e.formSubmit=function(){e.isNew?e.addClick():e.isNew||e.saveClick()},e.addClick=function(){var l={model:e.model,image:e.image,"delete":!1,isNew:!0};i.close(l)},e.saveClick=function(){var l={model:e.model,image:e.image,"delete":!1,isNew:!1};i.close(l)},e.deleteClick=function(){var l=confirm("Are you sure you want to delete "+e.model.title+"?");if(l){var o={model:e.model,image:e.image,"delete":!0,isNew:!1};i.close(o)}},e.cancelClick=function(){i.dismiss()},e.initialize()}]);
angular.module("games").controller("gamesCtrl",["$scope","$routeParams","$route","$http","$q","$location","upload","$modal","$filter","Games","Genres","Platforms","Tags","Users","gameService","$cookies","searchFilter","$timeout",function(e,t,n,a,r,i,u,o,l,s,c,g,m,f,d,p,h,v){"use strict";var I=this;I.countFinished=function(){return d.countFinished()},I.countFinishedPct=function(){return d.countFinishedPct()},I.isInSuggestions=function(e){return d.isInSuggestions(e)},I.addClick=function(){I.openGameForm(null)},I.editClick=function(e){I.openGameForm(e)},I.openGameForm=function(e){var t=o.open({templateUrl:"form.html",controller:"formCtrl",size:"lg",resolve:{game:function(){return e},genres:function(){return d.genres},platforms:function(){return d.platforms},tags:function(){return d.tags},games:function(){return d.games}}});t.result.then(function(t){I.formSubmit(e,t.model,t.image,t["delete"],t.isNew)})},I.formSubmit=function(e,t,n,a,r){if(t.rating&&0!=t.rating.length||(t.rating=null),a&&t.id)e.$delete({userId:I.userId},function(){var t=d.games.indexOf(e);t>-1&&d.games.splice(t,1),I.updateChart()});else if(r)e=new s(t),e.$save({userId:I.userId},function(){d.games.push(e),n&&n[0].files.length>0&&e.uploadImage(I.userId,n),I.updateChart()});else{var i=new s(t);i.$update({userId:I.userId},function(t){angular.copy(t,e),n&&n[0].files.length>0&&e.uploadImage(I.userId,n),I.updateChart()})}},I.manageGenresClick=function(){I.openManageForm(c,d.genres,"genre")},I.managePlatformsClick=function(){I.openManageForm(g,d.platforms,"platform")},I.manageTagsClick=function(){I.openManageForm(m,d.tags,"tag")},I.openManageForm=function(e,t){var n=o.open({templateUrl:"manage.html",controller:"manageFormCtrl",resolve:{Entities:function(){return e},items:function(){return t}}});n.result.then(function(n){var a=[];angular.forEach(n,function(e){e.deleted&&e.id?a.push(e.$delete({userId:I.userId},function(){for(var n=-1,a=0;a<t.length;a++){var r=t[a];if(r.id==e.id){n=a;break}}n>-1&&t.splice(n,1)})):e.updated&&e.id?a.push(e.$update({userId:I.userId},function(n){for(var a=0;a<t.length;a++){var r=t[a];if(r.id==e.id){angular.copy(n,r);break}}})):e.added&&!e.id&&a.push(e.$save({userId:I.userId},function(e){t.push(e)}))}),r.all(a).then(function(){var n=e.prototype.ids;angular.forEach(d.games,function(e){for(var a=0;a<e[n].length;a++){var r=e[n][a],i=!1;angular.forEach(t,function(e){r==e.id&&(i=!0)}),i||e[n].splice(a,1)}}),I.updateChart()})})},I.manageQueueClick=function(){var e=o.open({templateUrl:"queue.html",controller:"queueFormCtrl",size:"sm",resolve:{games:function(){return l("filter")(d.games,{queue_position:"!!"})}}});e.result.then(function(e){angular.forEach(e,function(e){for(var t=0;t<d.games.length;t++){var n=d.games[t];if(n.id==e.id){n.queue_position=e.queue_position,n.$update({userId:I.userId});break}}})})},I.pageChanged=function(){I.offset=I.currentPage*I.itemsPerPage-I.itemsPerPage},I.loginClick=function(){var e=o.open({templateUrl:"login.html",controller:"loginFormCtrl",size:"sm",resolve:{loginUrl:function(){return"api/login"}}});e.result.then(function(e){d.authenticated=!0,d.authenticatedUser=e})},I.logoutClick=function(){a.post("api/logout").success(function(){d.authenticated=!1,d.authenticatedUser=null})},I.aboutClick=function(){o.open({templateUrl:"about.html",size:"sm"})},I.viewChanged=function(e){(e==I.GRID_VIEW||e==I.LIST_VIEW)&&(I.view=e,p.view=e,v(function(){I.updateChart()},500))},I.gameSelected=function(e,t){I.selectedGame=e,t&&I.scrollToGame(e)},I.openLinkDialog=function(e){o.open({templateUrl:"link.html",controller:"linkCtrl",size:"sm",resolve:{url:function(){var t=i.protocol()+"://",n=i.host(),a=80!=i.port()?":"+i.port():"",r=window.location.pathname,u="#/"+I.userId,o="/"+e.id;return t+n+a+r+u+o}}})},I.changeUser=function(e){e.id!=I.userId&&(d.resetAll(),i.path("/"+e.id))},I.canShowAuthenticatedMenuItems=function(){return d.authenticated&&d.authenticatedUser.id==I.userId&&d.initialized},I.initFilter=function(){var e="Year",t="Rating",n="Miscellanous";I.filterOptions=[{name:"Title contains",value:d.FILTER_TITLE,group:n},{name:"Completion is",value:d.FILTER_COMPLETION,group:n},{name:"Platform is",value:d.FILTER_PLATFORM,group:n},{name:"Genre is",value:d.FILTER_GENRE,group:n},{name:"Tag is",value:d.FILTER_TAG,group:n},{name:"Year is exactly",value:d.FILTER_YEAR,group:e},{name:"Year is at least",value:d.FILTER_YEAR_MIN,group:e},{name:"Year is at most",value:d.FILTER_YEAR_MAX,group:e},{name:"Rating is exactly",value:d.FILTER_RATING,group:t},{name:"Rating is at least",value:d.FILTER_RATING_MIN,group:t},{name:"Rating is at most",value:d.FILTER_RATING_MAX,group:t}]},I.addQueryParameter=function(){I.query.parameters.push({type:null,value:null,negate:!1})},I.removeQueryParameter=function(e){var t=I.query.parameters.indexOf(e);t>-1&&I.query.parameters.splice(t,1)},I.resetFilter=function(){I.query||(I.query={}),I.query.parameters=[],I.sorting=I.sortOptions[0].value},I.toggleFilterPanel=function(){I.showFilters=!I.showFilters},I.isFilterOn=function(){return I.query&&I.query.parameters&&I.query.parameters.length},I.scrollToGame=function(e){if(I.sections.all_games&&I.collapseSection("all_games"),I.view==I.GRID_VIEW)for(var t=0;t<I.filtered.length;t++){var n=I.filtered[t];if(n==e){I.currentPage=parseInt(t/I.itemsPerPage)+1,v(function(){var t=$("#game"+e.id);if(t.length){var n=$("body,html");n.animate({scrollTop:t.offset().top-50-n.height()/2+t.height()/2})}});break}}else I.view==I.LIST_VIEW&&v(function(){var t=$("#game"+e.id);if(t.length){var n=$("#game-list");n.animate({scrollTop:n.scrollTop()+t.position().top+50-n.height()/2+t.height()/2})}})},I.collapseSection=function(e){var t=!I.sections[e];I.sections[e]=t,p[e]=t?1:0,"statistics"!=e||t||v(function(){I.chart.instance.resize(I.chart.instance.render,!0)})},I.changeTheme=function(){e.changeStyle(),I.updateChart()},I.refreshSuggestions=function(e){e.stopPropagation(),d.refreshSuggestions(I.userId)},I.updateChart=function(){var t=I.chart.orderBy(I.chart.xAxis(I.chart.yAxis)),n=[],a=[];angular.forEach(t,function(e){n.push(e.label),a.push(e.value)});var r={labels:n,datasets:[{fillColor:"rgba(151,187,205,0.2)",strokeColor:"rgba(151,187,205,1)",pointColor:"rgba(151,187,205,1)",pointStrokeColor:"#fff",pointHighlightFill:"#fff",pointHighlightStroke:"rgba(151,187,205,1)",data:a}]},i=document.getElementById("stats-chart").getContext("2d"),u={animation:!1,responsive:!0,scaleBeginsAtZero:!0,pointHitDetectionRadius:5,scaleFontColor:e.globalOptions.darkStyle?"#fff":"#333"};I.chart.instance&&I.chart.instance.destroy(),I.chart.instance=new Chart(i).Line(r,u)},I.initChart=function(){var e=function(e){var t=[];return angular.forEach(e,function(e){e.hasPlaytime()&&t.push(moment.duration(e.playtime).asHours())}),t},t=function(e){var t=[];return angular.forEach(e,function(e){e.hasRating()&&t.push(e.rating)}),t};I.chart={instance:null,xAxis:null,yAxis:null,orderBy:null,xOptions:[{name:"Genre",value:function(e){var t=[];return angular.forEach(d.genres,function(n){var a=l("filter")(d.getVisibleGames(),function(e){return e.genre_ids.indexOf(n.id)>-1});t.push({label:n.name,value:e(a)})}),t}},{name:"Platform",value:function(e){var t=[];return angular.forEach(d.platforms,function(n){var a=l("filter")(d.getVisibleGames(),function(e){return e.platform_ids.indexOf(n.id)>-1});t.push({label:n.name,value:e(a)})}),t}},{name:"Tag",value:function(e){var t=[];return angular.forEach(d.tags,function(n){var a=l("filter")(d.getVisibleGames(),function(e){return e.tag_ids.indexOf(n.id)>-1});t.push({label:n.name,value:e(a)})}),t}},{name:"Year",value:function(e){var t=[];return angular.forEach(d.getYears(),function(n){var a=l("filter")(d.getVisibleGames(),function(e){return e.year==n});t.push({label:n,value:e(a)})}),t}}],yOptions:[{name:"Games",group:"Quantity",value:function(e){return e.length}},{name:"Completed games",group:"Quantity",value:function(e){return e.reduce(function(e,t){return t.finished==d.FINISHED?e+1:e},0)}},{name:"Average playtime",group:"Playtime",value:function(t){var n=e(t);return n.length?n.reduce(function(e,t){return e+t},0)/n.length:0}},{name:"Median playtime",group:"Playtime",value:function(t){var n=e(t);if(!n.length)return 0;var a=l("orderBy")(n),r=Math.floor(a.length/2);return a.length%2?a[r]:(a[r-1]+a[r])/2}},{name:"Maximum playtime",group:"Playtime",value:function(t){return e(t).reduce(function(e,t){return Math.max(t,e)},0)}},{name:"Average rating",group:"Rating",value:function(e){var n=t(e);return n.length?n.reduce(function(e,t){return e+t},0)/n.length:0}},{name:"Maximum rating",group:"Rating",value:function(e){return t(e).reduce(function(e,t){return Math.max(t,e)},0)}}],orderOptions:[{name:"Category",value:function(e){return l("orderBy")(e,"label")}},{name:"Value",value:function(e){return l("orderBy")(e,"value")}}]},I.chart.xAxis=I.chart.xOptions[0].value,I.chart.yAxis=I.chart.yOptions[0].value,I.chart.orderBy=I.chart.orderOptions[0].value},I.init=function(){if(I.finishedOptions=[{name:"Completed",value:1},{name:"Not completed",value:0},{name:"Shelved",value:3},{name:"N/A",value:2}],I.sortOptions=[{name:"Sort by title, asc.",value:"sort_as"},{name:"Sort by title, desc.",value:"-sort_as"},{name:"Sort by year, asc.",value:["year","sort_as"]},{name:"Sort by year, desc.",value:[function(e){return null!=e.year?-e.year:Number.MAX_VALUE},"sort_as"]},{name:"Sort by rating, asc.",value:["rating","sort_as"]},{name:"Sort by rating, desc.",value:[function(e){return e.hasRating()?-e.rating:Number.MAX_VALUE},"sort_as"]},{name:"Sort by playtime, asc.",value:[function(e){return e.hasPlaytime()?e.playtimeAsInt():Number.MAX_VALUE},"sort_as"]},{name:"Sort by playtime, desc.",value:[function(e){return e.hasPlaytime()?-e.playtimeAsInt():Number.MAX_VALUE},"sort_as"]}],I.sections={currently_playing:1==p.currently_playing,queue:1==p.queue,all_games:1==p.all_games,statistics:1==p.statistics,suggestions:1==p.suggestions},I.offset=0,I.itemsPerPage=18,I.currentPage=1,I.showFilters=!1,I.selectedGame=null,I.GRID_VIEW=1,I.LIST_VIEW=2,I.view=p.view?p.view:I.LIST_VIEW,I.gameService=d,I.initFilter(),I.resetFilter(),I.initChart(),!t.userId)return void a.get("api/config").success(function(e){I.userId=e.default_user.id,i.path("/"+I.userId).replace()});I.userId=t.userId;var n=function(){t.gameId&&angular.forEach(d.getVisibleGames(),function(e){e.id==t.gameId&&I.gameSelected(e)}),v(function(){I.updateChart()})};if(d.initialized)n();else{d.checkLogin();var r=d.refreshAll(I.userId);r.then(n)}e.$watch(function(){return I.currentPage},function(){I.pageChanged()})},I.init()}]);
angular.module("games").controller("globalCtrl",["$scope","$cookies",function(l,t){l.globalOptions={darkStyle:!0},l.changeStyle=function(){l.globalOptions.darkStyle=!l.globalOptions.darkStyle,t.darkStyle=l.globalOptions.darkStyle?1:0},this.init=function(){l.globalOptions.darkStyle=1==t.darkStyle},this.init()}]);
angular.module("games").controller("linkCtrl",["$scope","$modalInstance","url",function(l,n,o){l.url=o}]);
angular.module("games").controller("loginFormCtrl",["$scope","$modalInstance","$http","loginUrl",function(o,r,n,l){o.loginClick=function(){o.loginError=!1,n.post(o.loginUrl,o.loginForm).success(function(n){o.resetForm(),r.close(n)}).error(function(){o.loginError=!0})},o.cancelClick=function(){o.resetForm(),r.dismiss()},o.resetForm=function(){o.loginError=!1,o.loginForm={username:"",password:""}},o.loginUrl=l,o.resetForm()}]);
angular.module("games").controller("manageFormCtrl",["$scope","$modalInstance","$filter","Entities","items",function(e,t,n,a,d){e.initialize=function(){e.form={},e.items=angular.copy(d),e.type=a.prototype.type,angular.forEach(e.items,function(e){e.added=!1,e.deleted=!1,e.updated=!1}),e.items=n("orderBy")(e.items,"name")},e.addClick=function(){var t=new a(e.form);t.added=!0,t.updated=!1,t.deleted=!1,e.items.push(t),e.form={}},e.deleteClick=function(e){e.added=!1,e.deleted=!0,e.updated=!1},e.nameChange=function(e){e.added||(e.updated=!0),e.short_name=e.name},e.shortNameChange=function(e){e.added||(e.updated=!0)},e.saveClick=function(){var n=e.items;t.close(n)},e.cancelClick=function(){t.dismiss()},e.canSave=function(){for(var t=0;t<e.items.length;t++){var n=e.items[t];if(!n.name||!n.short_name)return!1}return!0},e.initialize()}]);
angular.module("games").controller("queueFormCtrl",["$scope","$modalInstance","$filter","games",function(e,o,i,u){e.initialize=function(){e.games=angular.copy(u),e.rewriteQueue()},e.rewriteQueue=function(){e.games=i("orderBy")(e.games,["queue_position","sort_as"]);for(var o=0;o<e.games.length;o++)e.games[o].queue_position=o},e.getMaxPosition=function(){return e.games.reduce(function(e,o){return null==o.queue_position?e:e+1},0)-1},e.move=function(o,i){angular.forEach(e.games,function(e){e!=o&&null!=e.queue_position&&(e.queue_position>o.queue_position&&e.queue_position--,e.queue_position>=i&&e.queue_position++)}),o.queue_position=i},e.moveUpClick=function(o){0==o.queue_position?e.move(o,e.getMaxPosition()):e.move(o,o.queue_position-1)},e.moveDownClick=function(o){o.queue_position==e.getMaxPosition()?e.move(o,0):e.move(o,o.queue_position+1)},e.removeClick=function(o){angular.forEach(e.games,function(e){e!=o&&e.queue_position>=o.queue_position&&e.queue_position--}),o.queue_position=null},e.saveClick=function(){e.rewriteQueue(),o.close(e.games)},e.cancelClick=function(){o.dismiss()},e.initialize()}]);
angular.module("games").directive("bindElement",function(){return{restrict:"A",scope:{bindElement:"="},link:function(e,n){e.bindElement=n}}});
angular.module("games").directive("game",["gameService","$filter",function(e,t){return{restrict:"E",templateUrl:"game.html",scope:{game:"=",editCallback:"&",linkCallback:"&",height:"@"},link:function(i){i.heightStyle=i.height?{height:i.height}:{},i.gameService=e,i.getGenres=function(){return t("filter")(e.genres,function(e){return i.game.genre_ids.indexOf(e.id)>-1})},i.getPlatforms=function(){return t("filter")(e.platforms,function(e){return i.game.platform_ids.indexOf(e.id)>-1})},i.getTags=function(){return t("filter")(e.tags,function(e){return i.game.tag_ids.indexOf(e.id)>-1})}}}}]);
angular.module("games").directive("statsPanel",function(){return{templateUrl:"stats.html",scope:{panelTitle:"@",key:"@",value:"@",items:"=",filterBy:"=",orderBy:"=",descending:"@",onClick:"&"},link:function(e){e.itemsPerPage=10,e.pageChanged=function(){e.offset=e.currentPage*e.itemsPerPage-e.itemsPerPage},e.itemClicked=function(t){e.onClick({item:t})}}}});
angular.module("games").directive("validateTimespan",function(){return{require:"ngModel",link:function(e,n,t,i){var r=/^\d{1,2}:\d{2}(:\d{2})?$/;i.$validators.timespan=function(e,n){return i.$isEmpty(n)?!0:r.test(n)}}}}).directive("validateYear",function(){return{require:"ngModel",link:function(e,n,t,i){var r=/^\d+$/;i.$validators.year=function(e,n){return i.$isEmpty(n)?!0:r.test(n)}}}});
angular.module("games").factory("Games",["$resource","upload",function(t,e){var r=t("api/users/:userId/games/:id",{id:"@id"},{query:{method:"GET",isArray:!0,transformResponse:function(t){var e=angular.fromJson(t);return angular.forEach(e,function(t){n(t)}),e}},get:{method:"GET",isArray:!1,transformResponse:function(t){var e=angular.fromJson(t);return n(e)}},save:{method:"POST",transformResponse:function(t){var e=angular.fromJson(t);return n(e)}},update:{method:"PUT",transformResponse:function(t){var e=angular.fromJson(t);return n(e)}}}),n=function(t){if(t.decachedImage=t.image,t.currently_playing=1==t.currently_playing,t.title){var e=": ",r=t.title.indexOf(e);r>-1?(t.mainTitle=t.title.substr(0,r),t.subTitle=t.title.substr(r+e.length)):t.mainTitle=t.title}return t};return r.prototype.uploadImage=function(t,r){var n=this;return e({url:"api/users/"+t+"/games/"+this.id+"/image",method:"POST",data:{image:r}}).then(function(t){var e=t.data;n.image=e.image,n.decachedImage=n.image+"?q="+(new Date).getTime()})},r.prototype.playtimeAsInt=function(){return this.hasPlaytime()?parseInt(this.playtime.split(":").join("")):0},r.prototype.hasPlaytime=function(){return this.playtime&&"00:00:00"!=this.playtime},r.prototype.hasRating=function(){return null!=this.rating},r.prototype.getPlaytimeDisplay=function(){if(!this.playtime)return"";var t=this.playtime.split(":"),e=t[0],r=t[1];return 0==e.indexOf("00")?e="":0==e.indexOf("0")?e=e.substr(1)+" hours":e+=" hours",0==r.indexOf("00")?r="":0==r.indexOf("0")?r=r.substr(1)+" mins":r+=" mins",e+" "+r},r}]);
angular.module("games").factory("Users",["$resource",function(e){var r=e("api/users/:id",{id:"@id"},{update:{method:"PUT"}});return r}]);
angular.module("games").factory("Genres",["$resource",function(e){var r=e("api/users/:userId/genres/:id",{id:"@id"},{update:{method:"PUT"}});return r.prototype.type="genre",r.prototype.ids="genre_ids",r}]).factory("Platforms",["$resource",function(e){var r=e("api/users/:userId/platforms/:id",{id:"@id"},{update:{method:"PUT"}});return r.prototype.type="platform",r.prototype.ids="platform_ids",r}]).factory("Tags",["$resource",function(e){var r=e("api/users/:userId/tags/:id",{id:"@id"},{update:{method:"PUT"}});return r.prototype.type="tag",r.prototype.ids="tag_ids",r}]);
angular.module("games").filter("offset",function(){return function(e,n){return e.slice(n)}});
angular.module("games").filter("search",["gameService",function(e){return function(a,r){var t=r.search?r.search.toLowerCase():!1,n=[];return angular.forEach(a,function(a){if(t){var l=a.title&&a.title.toLowerCase().indexOf(t)>=0,u=a.sort_as&&a.sort_as.toLowerCase().indexOf(t)>=0,i=a.developer&&a.developer.toLowerCase().indexOf(t)>=0,o=a.publisher&&a.publisher.toLowerCase().indexOf(t)>=0,s=a.comment&&a.comment.toLowerCase().indexOf(t)>=0;if(!(l||u||i||o||s))return}var L=!0;angular.forEach(r.parameters,function(r){L&&r.type&&null!==r.value&&""!==r.value&&(r.type==e.FILTER_PLATFORM&&a.platform_ids.indexOf(r.value)<0?L=!1:r.type==e.FILTER_GENRE&&a.genre_ids.indexOf(r.value)<0?L=!1:r.type==e.FILTER_TAG&&a.tag_ids.indexOf(r.value)<0?L=!1:r.type!=e.FILTER_YEAR||null!=a.year&&a.year==r.value?r.type==e.FILTER_YEAR_MIN&&(null==a.year||a.year<r.value)?L=!1:r.type==e.FILTER_YEAR_MAX&&(null==a.year||a.year>r.value)?L=!1:r.type==e.FILTER_COMPLETION&&a.finished!=r.value?L=!1:r.type!=e.FILTER_RATING||null!=a.rating&&a.rating==r.value?r.type==e.FILTER_RATING_MIN&&(null==a.rating||a.rating<r.value)?L=!1:r.type==e.FILTER_RATING_MAX&&(null==a.rating||a.rating>r.value)?L=!1:r.type==e.FILTER_TITLE&&a.title.toLowerCase().indexOf(r.value)<0&&(L=!1):L=!1:L=!1,r.negate&&(L=!L))}),L&&n.push(a)}),n}}]);
angular.module("games").service("gameService",["Games","Genres","Platforms","Tags","Users","$q","$routeParams","$http","$filter",function(e,n,r,t,i,s,u,f,o){var a=this;a.refreshGames=function(n){return e.query({userId:n}).$promise.then(function(e){a.games=e})},a.refreshGenres=function(e){return n.query({userId:e}).$promise.then(function(e){a.genres=e})},a.refreshPlatforms=function(e){return r.query({userId:e}).$promise.then(function(e){a.platforms=e})},a.refreshTags=function(e){return t.query({userId:e}).$promise.then(function(e){a.tags=e})},a.refreshUsers=function(){return i.query().$promise.then(function(e){a.users=e})},a.refreshSuggestions=function(e){return f.get("api/users/"+e+"/suggestions").success(function(e){a.suggestions=e})},a.refreshAll=function(e){return a.resetAll(),s.all([a.refreshGames(e),a.refreshGenres(e),a.refreshPlatforms(e),a.refreshTags(e),a.refreshSuggestions(e),a.refreshUsers()]).then(function(){a.initialized=!0})},a.resetAll=function(){a.initialized=!1,a.games=[],a.genres=[],a.platforms=[],a.tags=[],a.suggestions=[],a.users=[]},a.checkLogin=function(){return f.get("api/login").success(function(e){a.authenticated=!0,a.authenticatedUser=e})},a.getVisibleGames=function(){return o("filter")(a.games,function(e){return e.hidden?a.authenticated&&a.authenticatedUser.id==e.user_id:!0})},a.getFinishedGames=function(){return o("filter")(a.getVisibleGames(),function(e){return e.finished==a.FINISHED})},a.getUnfinishedGames=function(){return o("filter")(a.getVisibleGames(),function(e){return e.finished!=a.FINISHED})},a.getYears=function(){var e=[];return angular.forEach(a.getVisibleGames(),function(n){n.year&&e.indexOf(n.year)<0&&e.push(n.year)}),e},a.countFinished=function(){return a.getVisibleGames().reduce(function(e,n){return n.finished==a.FINISHED?e+1:e},0)},a.countFinishedPct=function(){return Math.round(a.countFinished()/a.getVisibleGames().length*100)},a.countGenre=function(e){return a.getVisibleGames().reduce(function(n,r){return r.genre_ids.indexOf(e.id)>-1?n+1:n},0)},a.countPlatform=function(e){return a.getVisibleGames().reduce(function(n,r){return r.platform_ids.indexOf(e.id)>-1?n+1:n},0)},a.countTag=function(e){return a.getVisibleGames().reduce(function(n,r){return r.tag_ids.indexOf(e.id)>-1?n+1:n},0)},a.isInSuggestions=function(e){return a.suggestions.reduce(function(n,r){return n||r.game_id==e.id},!1)},a.FILTER_TITLE=1,a.FILTER_PLATFORM=2,a.FILTER_GENRE=3,a.FILTER_TAG=4,a.FILTER_YEAR=5,a.FILTER_RATING=6,a.FILTER_COMPLETION=7,a.FILTER_TITLE=8,a.FILTER_YEAR_MIN=9,a.FILTER_YEAR_MAX=10,a.FILTER_RATING_MIN=11,a.FILTER_RATING_MAX=12,a.NOT_FINISHED=0,a.FINISHED=1,a.FINISHED_NA=2,a.SHELVED=3,a.authenticated=!1,a.authenticatedUser=null,a.resetAll()}]);